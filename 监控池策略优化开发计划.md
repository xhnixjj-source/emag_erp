# 监控池监控策略优化开发计划

## 概述
根据需求优化监控池的监控策略，主要包括：链接获取方式优化、监控字段限制、7天监控限制、自动停止监控、前端展示简化、调度器开关修复。

## 数据库变更

### 1. 添加评分字段到 MonitorHistory 表
**文件**: `backend/app/models/monitor_pool.py`

- 在 `MonitorHistory` 模型中添加 `rating` 字段（Float类型，nullable=True）
- 创建数据库迁移脚本添加该字段

**影响**: 需要运行迁移脚本更新数据库结构

## 后端修改

### 2. 修改监控爬取逻辑 - 从FilterPool获取链接
**文件**: 
- `backend/app/services/crawler.py` (crawl_monitor_product函数)
- `backend/app/services/extractors/dynamic_data_extractor.py` (extract_rankings方法)

**修改内容**:
- 在 `crawl_monitor_product()` 中，通过 `monitor.filter_pool_id` 关联获取 `FilterPool` 记录
- 从 `FilterPool` 读取 `shop_url` 和 `category_url`
- 修改 `DynamicDataExtractor.extract_rankings()` 方法，接受外部传入的 `shop_url` 和 `category_url` 参数
- 如果链接存在，直接使用，跳过从页面提取链接的逻辑
- 如果链接不存在，记录警告但继续尝试从页面提取（向后兼容）

**关键代码位置**:
- `crawler.py:1331-1374` - crawl_monitor_product函数
- `dynamic_data_extractor.py:145-400` - extract_rankings方法

### 3. 限制监控字段为6个核心字段
**文件**: 
- `backend/app/services/crawler.py` (crawl_monitor_product函数)
- `backend/app/services/scheduler.py` (_crawl_single_monitor函数)

**修改内容**:
- 修改 `crawl_monitor_product()` 返回的数据，只包含以下字段：
  - `price` (价格)
  - `stock` 或 `stock_count` (库存)
  - `reviews_score` (评分，映射到 `rating`)
  - `shop_rank` 或 `store_rank` (店铺排名)
  - `category_rank` (类目排名)
  - `ad_rank` 或 `ad_category_rank` (广告排名)
- 修改 `_crawl_single_monitor()` 中创建 `MonitorHistory` 的逻辑，添加 `rating` 字段的映射

**关键代码位置**:
- `scheduler.py:196-205` - MonitorHistory创建逻辑

### 4. 添加7天监控限制
**文件**: `backend/app/services/scheduler.py`

**修改内容**:
- 在 `run_daily_monitor()` 中，添加7天限制过滤：
  - 如果 `last_monitored_at` 存在且距离现在超过7天，跳过监控
  - 如果 `last_monitored_at` 为None，使用 `created_at` 判断，超过7天则跳过
- 在 `trigger_monitor_manual()` 中添加相同的过滤逻辑
- 跳过时记录日志，但不报错

**关键代码位置**:
- `scheduler.py:72-140` - run_daily_monitor函数
- `scheduler.py:225-287` - trigger_monitor_manual函数

### 5. 进入利润测算时自动停止监控
**文件**: `backend/app/routers/listing.py`

**修改内容**:
- 在 `add_to_listing()` 函数中，添加产品到 listing pool 后
- 查找对应的 `MonitorPool` 记录（通过 `monitor_pool_id` 或 `product_url`）
- 将找到的监控项状态设为 `MonitorStatus.INACTIVE`
- 记录操作日志

**关键代码位置**:
- `listing.py:127-182` - add_to_listing函数

### 6. 修复调度器开关功能
**文件**: 
- `backend/app/routers/monitor.py` (update_schedule_config函数)
- `backend/app/services/scheduler.py` (start_scheduler函数)

**修改内容**:
- 在 `update_schedule_config()` 中，当 `enabled=False` 时，暂停调度器任务
- 当 `enabled=True` 时，恢复调度器任务
- 使用 `scheduler.pause_job()` 和 `scheduler.resume_job()` 控制任务
- 在 `start_scheduler()` 中，根据配置决定是否立即启动任务

**关键代码位置**:
- `monitor.py:396-433` - update_schedule_config函数
- `scheduler.py:18-63` - start_scheduler函数

### 7. 更新API响应模型
**文件**: `backend/app/routers/monitor.py`

**修改内容**:
- 在 `MonitorPoolResponse` 中添加 `rating` 字段（可选）
- 在 `MonitorHistoryResponse` 中添加 `rating` 字段
- 更新 `get_monitor_pool()` 和 `get_monitor_history()` 的响应构建逻辑

**关键代码位置**:
- `monitor.py:19-44` - MonitorPoolResponse模型
- `monitor.py:46-59` - MonitorHistoryResponse模型

## 前端修改

### 8. 简化前端展示 - 移除图表
**文件**: `frontend/src/views/MonitorPool.vue`

**修改内容**:
- 移除历史数据对话框中的图表组件（v-chart）
- 移除相关的 echarts 导入和 chartOption 计算属性
- 保留数据表格展示
- 可选：在表格中添加评分列显示

**关键代码位置**:
- `MonitorPool.vue:106-131` - 历史数据对话框
- `MonitorPool.vue:245-314` - chartOption计算属性

## 数据迁移脚本

### 9. 创建数据库迁移脚本
**文件**: `backend/migrate_add_rating_to_monitor_history.py` (新建)

**内容**:
- 为 `monitor_history` 表添加 `rating` 字段（REAL/FLOAT类型，nullable=True）
- 检查字段是否已存在，避免重复添加

## 开发任务清单

### 阶段1: 数据库和模型
- [ ] 创建数据库迁移脚本，为 monitor_history 表添加 rating 字段
- [ ] 更新 MonitorHistory 模型，添加 rating 字段

### 阶段2: 核心爬取逻辑
- [ ] 修改 crawl_monitor_product 函数，从 FilterPool 获取 shop_url 和 category_url
- [ ] 修改 DynamicDataExtractor.extract_rankings 方法，支持外部传入链接参数
- [ ] 限制监控字段为6个核心字段，添加 rating 字段映射

### 阶段3: 监控策略
- [ ] 在调度器中添加7天监控限制逻辑（基于 last_monitored_at 或 created_at）
- [ ] 在 add_to_listing 中添加逻辑，进入利润测算时自动将监控项设为 INACTIVE

### 阶段4: 调度器和API
- [ ] 修复调度器开关功能，使 enabled 参数真正控制调度器任务
- [ ] 更新 API 响应模型，添加 rating 字段到 MonitorPoolResponse 和 MonitorHistoryResponse

### 阶段5: 前端
- [ ] 简化前端展示，移除历史数据图表，保留数据表格

## 测试要点

1. **链接获取测试**: 验证从FilterPool获取链接的功能，包括链接存在和不存在的情况
2. **字段限制测试**: 验证只保存6个核心字段，其他字段被忽略
3. **7天限制测试**: 验证超过7天的监控项被正确跳过
4. **自动停止测试**: 验证进入利润测算后监控项状态变为INACTIVE
5. **调度器开关测试**: 验证开关能正确控制调度器的启用/禁用
6. **前端展示测试**: 验证图表已移除，数据表格正常显示

## 注意事项

1. **向后兼容**: 对于没有 `filter_pool_id` 或链接缺失的旧数据，需要降级处理
2. **数据一致性**: 确保FilterPool中的链接数据完整，建议在加入监控池时验证
3. **性能优化**: 从FilterPool获取链接可以减少页面访问，提升性能
4. **日志记录**: 添加适当的日志记录，便于排查问题
5. **错误处理**: 对于链接缺失、7天限制等情况，需要优雅处理，不中断整体流程

## 实施顺序建议

1. 数据库迁移（添加rating字段）
2. 后端核心逻辑修改（链接获取、字段限制）
3. 7天限制和自动停止功能
4. 调度器开关修复
5. API响应模型更新
6. 前端展示简化
7. 测试和验证

